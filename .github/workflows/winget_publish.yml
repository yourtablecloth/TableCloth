name: Submit to winget-pkgs repo

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to publish (e.g., v1.16.2)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  winget:
    name: Publish winget package
    runs-on: windows-latest
    steps:
      - name: Install wingetcreate
        run: |
          winget install --accept-source-agreements wingetcreate

      - name: Submit TableCloth WinGet Package Submission
        env:
          GITHUB_PAT: ${{ secrets.TABLECLOTH_GITHUB_PAT }}
        run: |
          $ErrorActionPreference = 'Stop'
          
          $PACKAGE_ID = "TableClothProject.TableCloth"
          $RELEASE_TAG = "${{ inputs.release_tag }}"

          # Validate tag format
          if ($RELEASE_TAG -notmatch '^v[0-9.]+$') {
            Write-Host "Invalid release tag format: $RELEASE_TAG"
            Write-Host "Expected format: v1.2.3"
            exit 1
          }

          # Fetching specified release from GitHub
          $response = Invoke-WebRequest -Uri "https://api.github.com/repos/yourtablecloth/TableCloth/releases/tags/$RELEASE_TAG" -UseBasicParsing
          $release = $response.Content | ConvertFrom-Json
          
          # Check if release is published (not draft)
          if ($release.draft -eq $true) {
            Write-Host "Release $RELEASE_TAG is still in draft state"
            Write-Host "Please publish the release before submitting to winget"
            exit 1
          }

          $PACKAGE_VERSION = $RELEASE_TAG -replace '^v', ''
          Write-Host "Processing release version: $PACKAGE_VERSION"

          # Get Velopack Setup.exe installer URLs for each architecture
          $x64Url = $release.assets | Where-Object { $_.name -match '.*x64\.exe$' -and $_.name -notmatch 'arm64' } | Select-Object -First 1 -ExpandProperty browser_download_url
          $arm64Url = $release.assets | Where-Object { $_.name -match '.*arm64\.exe$' } | Select-Object -First 1 -ExpandProperty browser_download_url

          if ([string]::IsNullOrEmpty($x64Url)) {
            Write-Host "x64 installer not found in release assets"
            exit 1
          }

          Write-Host "x64 Installer URL: $x64Url"

          # Build installer URLs string for wingetcreate
          if (-not [string]::IsNullOrEmpty($arm64Url)) {
            Write-Host "arm64 Installer URL: $arm64Url"
            $INSTALLER_URLS = "$x64Url|x64 $arm64Url|arm64"
          } else {
            Write-Host "arm64 installer not found, submitting x64 only"
            $INSTALLER_URLS = "$x64Url|x64"
          }

          # Update package using wingetcreate
          wingetcreate update "$PACKAGE_ID" --version "$PACKAGE_VERSION" --urls $INSTALLER_URLS --submit --token "$env:GITHUB_PAT"
        shell: pwsh
