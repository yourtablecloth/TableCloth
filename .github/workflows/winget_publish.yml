name: Submit to winget-pkgs repo

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  winget:
    name: Publish winget package
    runs-on: ubuntu-latest
    steps:
      - name: Install wingetcreate
        run: |
          dotnet tool install --global wingetcreate

      - name: Submit TableCloth WinGet Package Submission
        env:
          GITHUB_PAT: ${{ secrets.TABLECLOTH_GITHUB_PAT }}
        run: |
          set -e
          
          PACKAGE_ID="TableClothProject.TableCloth"

          # Fetching latest release from GitHub
          RELEASE_JSON=$(curl -s "https://api.github.com/repos/yourtablecloth/TableCloth/releases" | jq '[.[] | select(.tag_name | test("^v[0-9.]+$"))] | first')
          
          if [ "$RELEASE_JSON" == "null" ] || [ -z "$RELEASE_JSON" ]; then
            echo "No valid release found"
            exit 1
          fi

          PACKAGE_VERSION=$(echo "$RELEASE_JSON" | jq -r '.tag_name' | sed 's/^v//')
          echo "Found release version: $PACKAGE_VERSION"

          # Get Velopack Setup.exe installer URLs for each architecture
          X64_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | test("x64.*Setup\\.exe$") or (test("Setup\\.exe$") and (test("arm64") | not))) | .browser_download_url' | head -1)
          ARM64_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | test("arm64.*Setup\\.exe$")) | .browser_download_url' | head -1)

          if [ -z "$X64_URL" ]; then
            echo "x64 installer not found in release assets"
            exit 1
          fi

          echo "x64 Installer URL: $X64_URL"

          # Build installer URLs string for wingetcreate
          if [ -n "$ARM64_URL" ]; then
            echo "arm64 Installer URL: $ARM64_URL"
            INSTALLER_URLS="$X64_URL|x64 $ARM64_URL|arm64"
          else
            echo "arm64 installer not found, submitting x64 only"
            INSTALLER_URLS="$X64_URL|x64"
          fi

          # Update package using wingetcreate
          wingetcreate update "$PACKAGE_ID" --version "$PACKAGE_VERSION" --urls $INSTALLER_URLS --submit --token "$GITHUB_PAT"
        shell: bash
