name: Submit to winget-pkgs repo

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  winget:
    name: Publish winget package
    runs-on: windows-latest
    steps:
      - name: Install wingetcreate
        run: |
          winget install --accept-source-agreements wingetcreate

      - name: Submit TableCloth WinGet Package Submission
        env:
          GITHUB_PAT: ${{ secrets.TABLECLOTH_GITHUB_PAT }}
        run: |
          $ErrorActionPreference = 'Stop'
          
          $PACKAGE_ID = "TableClothProject.TableCloth"

          # Fetching latest release from GitHub
          $response = Invoke-WebRequest -Uri "https://api.github.com/repos/yourtablecloth/TableCloth/releases" -UseBasicParsing
          $releases = $response.Content | ConvertFrom-Json
          
          # Find the latest release with version tag
          $latestRelease = $releases | Where-Object { $_.tag_name -match '^v[0-9.]+$' } | Select-Object -First 1
          
          if ($null -eq $latestRelease) {
            Write-Host "No valid release found"
            exit 1
          }

          $PACKAGE_VERSION = $latestRelease.tag_name -replace '^v', ''
          Write-Host "Found release version: $PACKAGE_VERSION"

          # Get Velopack Setup.exe installer URLs for each architecture
          $x64Url = $latestRelease.assets | Where-Object { $_.name -match '.*x64\.exe$' -and $_.name -notmatch 'arm64' } | Select-Object -First 1 -ExpandProperty browser_download_url
          $arm64Url = $latestRelease.assets | Where-Object { $_.name -match '.*arm64\.exe$' } | Select-Object -First 1 -ExpandProperty browser_download_url

          if ([string]::IsNullOrEmpty($x64Url)) {
            Write-Host "x64 installer not found in release assets"
            exit 1
          }

          Write-Host "x64 Installer URL: $x64Url"

          # Build installer URLs string for wingetcreate
          if (-not [string]::IsNullOrEmpty($arm64Url)) {
            Write-Host "arm64 Installer URL: $arm64Url"
            $INSTALLER_URLS = "$x64Url|x64 $arm64Url|arm64"
          } else {
            Write-Host "arm64 installer not found, submitting x64 only"
            $INSTALLER_URLS = "$x64Url|x64"
          }

          # Update package using wingetcreate
          wingetcreate update "$PACKAGE_ID" --version "$PACKAGE_VERSION" --urls $INSTALLER_URLS --submit --token "$env:GITHUB_PAT"
        shell: pwsh
